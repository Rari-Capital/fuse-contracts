// SPDX-License-Identifier: UNLICENSED
pragma solidity 0.6.12;
pragma experimental ABIEncoderV2;

import "@openzeppelin/contracts-upgradeable/proxy/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/utils/AddressUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/token/ERC20/IERC20Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/token/ERC20/SafeERC20Upgradeable.sol";

/**
 * @title FuseFeeDistributor
 * @author David Lucid <david@rari.capital> (https://github.com/davidlucid)
 * @notice FuseFeeDistributor controls and receives protocol fees from Fuse pools and relays admin actions to Fuse pools.
 */
contract FuseFeeDistributor is Initializable, OwnableUpgradeable {
    using AddressUpgradeable for address;
    using SafeERC20Upgradeable for IERC20Upgradeable;

    /**
     * @dev Initializer that sets the proportion of Fuse pool interest taken as a protocol fee.
     * @param _interestFeeRate The proportion of Fuse pool interest taken as a protocol fee (scaled by 1e18).
     */
    function initialize(uint256 _interestFeeRate) public initializer {
        require(_interestFeeRate <= 1e18, "Interest fee rate cannot be more than 100%.");
        __Ownable_init();
        interestFeeRate = _interestFeeRate;
        maxSupplyEth = uint256(-1);
        maxUtilizationRate = uint256(-1);
        comptrollerImplementationWhitelist[address(0)][0x94B2200d28932679DEF4A7d08596A229553a994E] = true;
        comptrollerImplementationWhitelist[address(0)][0x8A78A9D35c9C61F9E0Ff526C5d88eC28354543fE] = true;
        cErc20DelegateWhitelist[address(0)][0x67E70eeB9DD170f7B4A9EF620720c9069D5e706C][false] = true;
        cErc20DelegateWhitelist[address(0)][0x2b3dD0AE288c13a730F6C422e2262a9d3dA79Ed1][false] = true;
        cEtherDelegateWhitelist[address(0)][0x60884c8FAaD1B30B1C76100dA92B76eD3aF849ba][false] = true;
    }

    /**
     * @notice The proportion of Fuse pool interest taken as a protocol fee (scaled by 1e18).
     */
    uint256 public interestFeeRate;

    /**
     * @dev Sets the proportion of Fuse pool interest taken as a protocol fee.
     * @param _interestFeeRate The proportion of Fuse pool interest taken as a protocol fee (scaled by 1e18).
     */
    function _setInterestFeeRate(uint256 _interestFeeRate) external onlyOwner {
        require(_interestFeeRate <= 1e18, "Interest fee rate cannot be more than 100%.");
        interestFeeRate = _interestFeeRate;
    }

    /**
     * @dev Withdraws accrued fees on interest.
     * @param erc20Contract The ERC20 token address to withdraw. Set to the zero address to withdraw ETH.
     */
    function _withdrawAssets(address erc20Contract) external {
        if (erc20Contract == address(0)) {
            uint256 balance = address(this).balance;
            require(balance > 0, "No balance available to withdraw.");
            (bool success, ) = owner().call{value: balance}("");
            require(success, "Failed to transfer ETH balance to msg.sender.");
        } else {
            IERC20Upgradeable token = IERC20Upgradeable(erc20Contract);
            uint256 balance = token.balanceOf(address(this));
            require(balance > 0, "No token balance available to withdraw.");
            token.safeTransfer(owner(), balance);
        }
    }

    /**
     * @dev Minimum borrow balance (in ETH) per user per Fuse pool asset (only checked on new borrows, not redemptions).
     */
    uint256 public minBorrowEth;

    /**
     * @dev Maximum supply balance (in ETH) per user per Fuse pool asset.
     */
    uint256 public maxSupplyEth;

    /**
     * @dev Maximum utilization rate (scaled by 1e18) for Fuse pool assets (only checked on new borrows, not redemptions).
     */
    uint256 public maxUtilizationRate;

    /**
     * @dev Sets the proportion of Fuse pool interest taken as a protocol fee.
     * @param _minBorrowEth Minimum borrow balance (in ETH) per user per Fuse pool asset (only checked on new borrows, not redemptions).
     * @param _maxSupplyEth Maximum supply balance (in ETH) per user per Fuse pool asset.
     * @param _maxUtilizationRate Maximum utilization rate (scaled by 1e18) for Fuse pool assets (only checked on new borrows, not redemptions).
     */
    function _setPoolLimits(uint256 _minBorrowEth, uint256 _maxSupplyEth, uint256 _maxUtilizationRate) external onlyOwner {
        minBorrowEth = _minBorrowEth;
        maxSupplyEth = _maxSupplyEth;
        maxUtilizationRate = _maxUtilizationRate;
    }

    /**
     * @dev Receives ETH fees.
     */
    receive() external payable { }

    /**
     * @dev Sends data to a contract.
     * @param targets The contracts to which `data` will be sent.
     * @param data The data to be sent to each of `targets`.
     */
    function _callPool(address[] calldata targets, bytes[] calldata data) external onlyOwner {
        require(targets.length > 0 && targets.length == data.length, "Array lengths must be equal and greater than 0.");
        for (uint256 i = 0; i < targets.length; i++) targets[i].functionCall(data[i]);
    }

    /**
     * @dev Sends data to a contract.
     * @param targets The contracts to which `data` will be sent.
     * @param data The data to be sent to each of `targets`.
     */
    function _callPool(address[] calldata targets, bytes calldata data) external onlyOwner {
        require(targets.length > 0, "No target addresses specified.");
        for (uint256 i = 0; i < targets.length; i++) targets[i].functionCall(data);
    }

    function deployCEther(bytes calldata constructorData) external returns (address) {
        // Make sure comptroller == msg.sender
        (address comptroller) = abi.decode(constructorData[0:32], (address));
        require(comptroller == msg.sender, "Comptroller is not sender.");

        // Deploy Unitroller using msg.sender, underlying, and block.number as a salt
        bytes memory cEtherDelegatorCreationCode = hex"60806040523480156200001157600080fd5b506040516200143b3803806200143b83398181016040526101408110156200003857600080fd5b8151602083015160408085015160608601805192519496939591949391820192846401000000008211156200006c57600080fd5b9083019060208201858111156200008257600080fd5b82516401000000008111828201881017156200009d57600080fd5b82525081516020918201929091019080838360005b83811015620000cc578181015183820152602001620000b2565b50505050905090810190601f168015620000fa5780820380516001836020036101000a031916815260200191505b50604052602001805160405193929190846401000000008211156200011e57600080fd5b9083019060208201858111156200013457600080fd5b82516401000000008111828201881017156200014f57600080fd5b82525081516020918201929091019080838360005b838110156200017e57818101518382015260200162000164565b50505050905090810190601f168015620001ac5780820380516001836020036101000a031916815260200191505b50604081815260208301519083015160609093018051919593949293929184640100000000821115620001de57600080fd5b908301906020820185811115620001f457600080fd5b82516401000000008111828201881017156200020f57600080fd5b82525081516020918201929091019080838360005b838110156200023e57818101518382015260200162000224565b50505050905090810190601f1680156200026c5780820380516001836020036101000a031916815260200191505b506040526020018051906020019092919080519060200190929190505050620003ff848b8b8b8b8b8b898960405160240180896001600160a01b03166001600160a01b03168152602001886001600160a01b03166001600160a01b0316815260200187815260200180602001806020018660ff1660ff168152602001858152602001848152602001838103835288818151815260200191508051906020019080838360005b838110156200032b57818101518382015260200162000311565b50505050905090810190601f168015620003595780820380516001836020036101000a031916815260200191505b50838103825287518152875160209182019189019080838360005b838110156200038e57818101518382015260200162000374565b50505050905090810190601f168015620003bc5780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b039081166301f10abd60e31b17909152909b5062000427169950505050505050505050565b5062000417846000856001600160e01b03620004ee16565b5050505050505050505062000759565b606060006060846001600160a01b0316846040518082805190602001908083835b60208310620004695780518252601f19909201916020918201910162000448565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114620004cb576040519150601f19603f3d011682016040523d82523d6000602084013e620004d0565b606091505b50915091506000821415620004e6573d60208201fd5b949350505050565b60005460408051630304735160e61b81526001600160a01b0392831660048201529185166024830152831515604483015251734826533b4897376654bb4d4ad88b7fafd0c985289163c11cd440916064808301926020929190829003018186803b1580156200055c57600080fd5b505afa15801562000571573d6000803e3d6000fd5b505050506040513d60208110156200058857600080fd5b5051620005c75760405162461bcd60e51b8152600401808060200182810382526054815260200180620013e76054913960600191505060405180910390fd5b811562000609576040805160048152602481019091526020810180516001600160e01b0390811663153ab50560e01b179091526200060791906200072f16565b505b600080546001600160a01b038581166001600160a01b031983161783556040516020602482018181528651604484015286519390941694620006e09487949093849360649091019290860191908190849084905b83811015620006775781810151838201526020016200065d565b50505050905090810190601f168015620006a55780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b03908116630adccee560e31b179091529093506200072f16915050565b50600054604080516001600160a01b038085168252909216602083015280517fd604de94d45953f9138079ec1b82d533cb2160c906d1076d1f7ed54befbca97a9281900390910190a150505050565b60005460609062000753906001600160a01b0316836001600160e01b036200042716565b92915050565b610c7e80620007696000396000f3fe6080604052600436106100345760003560e01c80630933c1ed1461024a578063555bcc40146103725780635c60da1b1461043e575b61003c61046f565b156101c7576000805460408051638abe0b7560e01b81526001600160a01b039092166004830152518291606091734826533b4897376654bb4d4ad88b7fafd0c9852891638abe0b759160248083019287929190829003018186803b1580156100a357600080fd5b505afa1580156100b7573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405260608110156100e057600080fd5b8151602083015160408085018051915193959294830192918464010000000082111561010b57600080fd5b90830190602082018581111561012057600080fd5b825164010000000081118282018810171561013a57600080fd5b82525081516020918201929091019080838360005b8381101561016757818101518382015260200161014f565b50505050905090810190601f1680156101945780820380516001836020036101000a031916815260200191505b5060405250506000549396509194509250506001600160a01b038085169116146101c3576101c38383836105dd565b5050505b600080546040516001600160a01b0390911690829036908083838082843760405192019450600093509091505080830381855af49150503d806000811461022a576040519150601f19603f3d011682016040523d82523d6000602084013e61022f565b606091505b505090506040513d6000823e818015610246573d82f35b3d82fd5b34801561025657600080fd5b506102fd6004803603602081101561026d57600080fd5b81019060208101813564010000000081111561028857600080fd5b82018360208201111561029a57600080fd5b803590602001918460018302840111640100000000831117156102bc57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610807945050505050565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561033757818101518382015260200161031f565b50505050905090810190601f1680156103645780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561037e57600080fd5b5061043c6004803603606081101561039557600080fd5b6001600160a01b038235169160208101351515918101906060810160408201356401000000008111156103c757600080fd5b8201836020820111156103d957600080fd5b803590602001918460018302840111640100000000831117156103fb57600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610826945050505050565b005b34801561044a57600080fd5b50610453610879565b604080516001600160a01b039092168252519081900360200190f35b6000805460408051600481526024810182526020810180516001600160e01b0316635fe3b56760e01b1781529151815185946060946001600160a01b039091169392918291908083835b602083106104d85780518252601f1990920191602091820191016104b9565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855afa9150503d8060008114610538576040519150601f19603f3d011682016040523d82523d6000602084013e61053d565b606091505b50915091508161054c57600080fd5b600081806020019051602081101561056357600080fd5b505160408051633757348b60e21b815290519192506001600160a01b0383169163dd5cd22c91600480820192602092909190829003018186803b1580156105a957600080fd5b505afa1580156105bd573d6000803e3d6000fd5b505050506040513d60208110156105d357600080fd5b5051935050505090565b60005460408051630304735160e61b81526001600160a01b0392831660048201529185166024830152831515604483015251734826533b4897376654bb4d4ad88b7fafd0c985289163c11cd440916064808301926020929190829003018186803b15801561064a57600080fd5b505afa15801561065e573d6000803e3d6000fd5b505050506040513d602081101561067457600080fd5b50516106b15760405162461bcd60e51b8152600401808060200182810382526054815260200180610bf66054913960600191505060405180910390fd5b81156106eb576040805160048152602481019091526020810180516001600160e01b031663153ab50560e01b1790526106e990610807565b505b600080546001600160a01b038581166001600160a01b0319831617835560405160206024820181815286516044840152865193909416946107b89487949093849360649091019290860191908190849084905b8381101561075657818101518382015260200161073e565b50505050905090810190601f1680156107835780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b0316630adccee560e31b1790529250610807915050565b50600054604080516001600160a01b038085168252909216602083015280517fd604de94d45953f9138079ec1b82d533cb2160c906d1076d1f7ed54befbca97a9281900390910190a150505050565b600054606090610820906001600160a01b031683610888565b92915050565b61082e61094a565b6108695760405162461bcd60e51b8152600401808060200182810382526039815260200180610bbd6039913960400191505060405180910390fd5b6108748383836105dd565b505050565b6000546001600160a01b031681565b606060006060846001600160a01b0316846040518082805190602001908083835b602083106108c85780518252601f1990920191602091820191016108a9565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610928576040519150601f19603f3d011682016040523d82523d6000602084013e61092d565b606091505b50915091506000821415610942573d60208201fd5b949350505050565b6000805460408051600481526024810182526020810180516001600160e01b0316635fe3b56760e01b1781529151815185946060946001600160a01b039091169392918291908083835b602083106109b35780518252601f199092019160209182019101610994565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855afa9150503d8060008114610a13576040519150601f19603f3d011682016040523d82523d6000602084013e610a18565b606091505b509150915081610a2757600080fd5b6000818060200190516020811015610a3e57600080fd5b5051604080516303e1469160e61b8152905191925082916001600160a01b0383169163f851a440916004808301926020929190829003018186803b158015610a8557600080fd5b505afa158015610a99573d6000803e3d6000fd5b505050506040513d6020811015610aaf57600080fd5b50516001600160a01b031633148015610b295750806001600160a01b0316630a755ec26040518163ffffffff1660e01b815260040160206040518083038186803b158015610afc57600080fd5b505afa158015610b10573d6000803e3d6000fd5b505050506040513d6020811015610b2657600080fd5b50515b80610bb3575033734826533b4897376654bb4d4ad88b7fafd0c98528148015610bb35750806001600160a01b0316632f1069ba6040518163ffffffff1660e01b815260040160206040518083038186803b158015610b8657600080fd5b505afa158015610b9a573d6000803e3d6000fd5b505050506040513d6020811015610bb057600080fd5b50515b9450505050509056fe43457468657244656c656761746f723a3a5f736574496d706c656d656e746174696f6e3a2043616c6c6572206d7573742062652061646d696e4e657720696d706c656d656e746174696f6e20636f6e74726163742061646472657373206e6f742077686974656c6973746564206f7220616c6c6f7752657369676e206d75737420626520696e7665727465642ea265627a7a7231582095a3fddd1225651a5ae1b94a5bdcec9b5ba98f766a15cdab82dcce692ee4c05c64736f6c634300051100324e657720696d706c656d656e746174696f6e20636f6e74726163742061646472657373206e6f742077686974656c6973746564206f7220616c6c6f7752657369676e206d75737420626520696e7665727465642e";
        cEtherDelegatorCreationCode = abi.encode(cEtherDelegatorCreationCode, constructorData);
        bytes32 salt = keccak256(abi.encodePacked(msg.sender, address(0), block.number));
        address proxy;

        assembly {
            proxy := create2(0, add(cEtherDelegatorCreationCode, 32), mload(cEtherDelegatorCreationCode), salt)
        }

        return proxy;
    }

    function deployCErc20(bytes calldata constructorData) external returns (address) {
        // Make sure comptroller == msg.sender
        (address underlying, address comptroller) = abi.decode(constructorData[0:64], (address, address));
        require(comptroller == msg.sender, "Comptroller is not sender.");

        // Deploy CErc20Delegator using msg.sender, underlying, and block.number as a salt
        bytes memory cErc20DelegatorCreationCode = hex"60806040523480156200001157600080fd5b50604051620014d2380380620014d283398181016040526101608110156200003857600080fd5b81516020830151604080850151606086015160808701805193519597949692959194919392820192846401000000008211156200007457600080fd5b9083019060208201858111156200008a57600080fd5b8251640100000000811182820188101715620000a557600080fd5b82525081516020918201929091019080838360005b83811015620000d4578181015183820152602001620000ba565b50505050905090810190601f168015620001025780820380516001836020036101000a031916815260200191505b50604052602001805160405193929190846401000000008211156200012657600080fd5b9083019060208201858111156200013c57600080fd5b82516401000000008111828201881017156200015757600080fd5b82525081516020918201929091019080838360005b83811015620001865781810151838201526020016200016c565b50505050905090810190601f168015620001b45780820380516001836020036101000a031916815260200191505b50604081815260208301519083015160609093018051919593949293929184640100000000821115620001e657600080fd5b908301906020820185811115620001fc57600080fd5b82516401000000008111828201881017156200021757600080fd5b82525081516020918201929091019080838360005b83811015620002465781810151838201526020016200022c565b50505050905090810190601f168015620002745780820380516001836020036101000a031916815260200191505b50604052602001805190602001909291908051906020019092919050505062000421848c8c8c8c8c8c8c8a8a604051602401808a6001600160a01b03166001600160a01b03168152602001896001600160a01b03166001600160a01b03168152602001886001600160a01b03166001600160a01b0316815260200187815260200180602001806020018660ff1660ff168152602001858152602001848152602001838103835288818151815260200191508051906020019080838360005b838110156200034c57818101518382015260200162000332565b50505050905090810190601f1680156200037a5780820380516001836020036101000a031916815260200191505b50838103825287518152875160209182019189019080838360005b83811015620003af57818101518382015260200162000395565b50505050905090810190601f168015620003dd5780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b03908116630867bd9760e21b17909152909c506200044a169a5050505050505050505050565b5062000439846000856001600160e01b036200051116565b50505050505050505050506200077c565b606060006060846001600160a01b0316846040518082805190602001908083835b602083106200048c5780518252601f1990920191602091820191016200046b565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114620004ee576040519150601f19603f3d011682016040523d82523d6000602084013e620004f3565b606091505b5091509150600082141562000509573d60208201fd5b949350505050565b600054604080516338e6a07360e11b81526001600160a01b0392831660048201529185166024830152831515604483015251734826533b4897376654bb4d4ad88b7fafd0c98528916371cd40e6916064808301926020929190829003018186803b1580156200057f57600080fd5b505afa15801562000594573d6000803e3d6000fd5b505050506040513d6020811015620005ab57600080fd5b5051620005ea5760405162461bcd60e51b81526004018080602001828103825260548152602001806200147e6054913960600191505060405180910390fd5b81156200062c576040805160048152602481019091526020810180516001600160e01b0390811663153ab50560e01b179091526200062a91906200075216565b505b600080546001600160a01b038581166001600160a01b031983161783556040516020602482018181528651604484015286519390941694620007039487949093849360649091019290860191908190849084905b838110156200069a57818101518382015260200162000680565b50505050905090810190601f168015620006c85780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b03908116630adccee560e31b179091529093506200075216915050565b50600054604080516001600160a01b038085168252909216602083015280517fd604de94d45953f9138079ec1b82d533cb2160c906d1076d1f7ed54befbca97a9281900390910190a150505050565b60005460609062000776906001600160a01b0316836001600160e01b036200044a16565b92915050565b610cf2806200078c6000396000f3fe6080604052600436106100345760003560e01c80630933c1ed14610287578063555bcc40146103af5780635c60da1b1461047b575b34156100715760405162461bcd60e51b8152600401808060200182810382526037815260200180610bfa6037913960400191505060405180910390fd5b6100796104ac565b15610204576000805460408051638abe0b7560e01b81526001600160a01b039092166004830152518291606091734826533b4897376654bb4d4ad88b7fafd0c9852891638abe0b759160248083019287929190829003018186803b1580156100e057600080fd5b505afa1580156100f4573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052606081101561011d57600080fd5b8151602083015160408085018051915193959294830192918464010000000082111561014857600080fd5b90830190602082018581111561015d57600080fd5b825164010000000081118282018810171561017757600080fd5b82525081516020918201929091019080838360005b838110156101a457818101518382015260200161018c565b50505050905090810190601f1680156101d15780820380516001836020036101000a031916815260200191505b5060405250506000549396509194509250506001600160a01b038085169116146102005761020083838361061a565b5050505b600080546040516001600160a01b0390911690829036908083838082843760405192019450600093509091505080830381855af49150503d8060008114610267576040519150601f19603f3d011682016040523d82523d6000602084013e61026c565b606091505b505090506040513d6000823e818015610283573d82f35b3d82fd5b34801561029357600080fd5b5061033a600480360360208110156102aa57600080fd5b8101906020810181356401000000008111156102c557600080fd5b8201836020820111156102d757600080fd5b803590602001918460018302840111640100000000831117156102f957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610844945050505050565b6040805160208082528351818301528351919283929083019185019080838360005b8381101561037457818101518382015260200161035c565b50505050905090810190601f1680156103a15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156103bb57600080fd5b50610479600480360360608110156103d257600080fd5b6001600160a01b0382351691602081013515159181019060608101604082013564010000000081111561040457600080fd5b82018360208201111561041657600080fd5b8035906020019184600183028401116401000000008311171561043857600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600092019190915250929550610863945050505050565b005b34801561048757600080fd5b506104906108b6565b604080516001600160a01b039092168252519081900360200190f35b6000805460408051600481526024810182526020810180516001600160e01b0316635fe3b56760e01b1781529151815185946060946001600160a01b039091169392918291908083835b602083106105155780518252601f1990920191602091820191016104f6565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855afa9150503d8060008114610575576040519150601f19603f3d011682016040523d82523d6000602084013e61057a565b606091505b50915091508161058957600080fd5b60008180602001905160208110156105a057600080fd5b505160408051633757348b60e21b815290519192506001600160a01b0383169163dd5cd22c91600480820192602092909190829003018186803b1580156105e657600080fd5b505afa1580156105fa573d6000803e3d6000fd5b505050506040513d602081101561061057600080fd5b5051935050505090565b600054604080516338e6a07360e11b81526001600160a01b0392831660048201529185166024830152831515604483015251734826533b4897376654bb4d4ad88b7fafd0c98528916371cd40e6916064808301926020929190829003018186803b15801561068757600080fd5b505afa15801561069b573d6000803e3d6000fd5b505050506040513d60208110156106b157600080fd5b50516106ee5760405162461bcd60e51b8152600401808060200182810382526054815260200180610c316054913960600191505060405180910390fd5b8115610728576040805160048152602481019091526020810180516001600160e01b031663153ab50560e01b17905261072690610844565b505b600080546001600160a01b038581166001600160a01b0319831617835560405160206024820181815286516044840152865193909416946107f59487949093849360649091019290860191908190849084905b8381101561079357818101518382015260200161077b565b50505050905090810190601f1680156107c05780820380516001836020036101000a031916815260200191505b5060408051601f198184030181529190526020810180516001600160e01b0316630adccee560e31b1790529250610844915050565b50600054604080516001600160a01b038085168252909216602083015280517fd604de94d45953f9138079ec1b82d533cb2160c906d1076d1f7ed54befbca97a9281900390910190a150505050565b60005460609061085d906001600160a01b0316836108c5565b92915050565b61086b610987565b6108a65760405162461bcd60e51b8152600401808060200182810382526039815260200180610c856039913960400191505060405180910390fd5b6108b183838361061a565b505050565b6000546001600160a01b031681565b606060006060846001600160a01b0316846040518082805190602001908083835b602083106109055780518252601f1990920191602091820191016108e6565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d8060008114610965576040519150601f19603f3d011682016040523d82523d6000602084013e61096a565b606091505b5091509150600082141561097f573d60208201fd5b949350505050565b6000805460408051600481526024810182526020810180516001600160e01b0316635fe3b56760e01b1781529151815185946060946001600160a01b039091169392918291908083835b602083106109f05780518252601f1990920191602091820191016109d1565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855afa9150503d8060008114610a50576040519150601f19603f3d011682016040523d82523d6000602084013e610a55565b606091505b509150915081610a6457600080fd5b6000818060200190516020811015610a7b57600080fd5b5051604080516303e1469160e61b8152905191925082916001600160a01b0383169163f851a440916004808301926020929190829003018186803b158015610ac257600080fd5b505afa158015610ad6573d6000803e3d6000fd5b505050506040513d6020811015610aec57600080fd5b50516001600160a01b031633148015610b665750806001600160a01b0316630a755ec26040518163ffffffff1660e01b815260040160206040518083038186803b158015610b3957600080fd5b505afa158015610b4d573d6000803e3d6000fd5b505050506040513d6020811015610b6357600080fd5b50515b80610bf0575033734826533b4897376654bb4d4ad88b7fafd0c98528148015610bf05750806001600160a01b0316632f1069ba6040518163ffffffff1660e01b815260040160206040518083038186803b158015610bc357600080fd5b505afa158015610bd7573d6000803e3d6000fd5b505050506040513d6020811015610bed57600080fd5b50515b9450505050509056fe43457263323044656c656761746f723a66616c6c6261636b3a2063616e6e6f742073656e642076616c756520746f2066616c6c6261636b4e657720696d706c656d656e746174696f6e20636f6e74726163742061646472657373206e6f742077686974656c6973746564206f7220616c6c6f7752657369676e206d75737420626520696e7665727465642e43457263323044656c656761746f723a3a5f736574496d706c656d656e746174696f6e3a2043616c6c6572206d7573742062652061646d696ea265627a7a72315820c21e5786c5e5c92c72251c2ad4d2bd4e5971d71fa1dbf90ed8ed352b39f4f2ba64736f6c634300051100324e657720696d706c656d656e746174696f6e20636f6e74726163742061646472657373206e6f742077686974656c6973746564206f7220616c6c6f7752657369676e206d75737420626520696e7665727465642e";
        cErc20DelegatorCreationCode = abi.encode(cErc20DelegatorCreationCode, constructorData);
        bytes32 salt = keccak256(abi.encodePacked(msg.sender, underlying, block.number));
        address proxy;

        assembly {
            proxy := create2(0, add(cErc20DelegatorCreationCode, 32), mload(cErc20DelegatorCreationCode), salt)
        }

        return proxy;
    }

    /**
     * @dev Whitelisted Comptroller implementation contract addresses for each existing implementation.
     */
    mapping(address => mapping(address => bool)) public comptrollerImplementationWhitelist;

    /**
     * @dev Adds/removes Comptroller implementations to the whitelist.
     * @param oldImplementations The old `Comptroller` implementation addresses to upgrade from for each `newImplementations` to upgrade to.
     * @param newImplementations Array of `Comptroller` implementations to be whitelisted/unwhitelisted.
     * @param statuses Array of whitelist statuses corresponding to `implementations`.
     */
    function _editComptrollerImplementationWhitelist(address[] calldata oldImplementations, address[] calldata newImplementations, bool[] calldata statuses) external onlyOwner {
        require(newImplementations.length > 0 && newImplementations.length == oldImplementations.length && newImplementations.length == statuses.length, "No Comptroller implementations supplied or array lengths not equal.");
        for (uint256 i = 0; i < newImplementations.length; i++) comptrollerImplementationWhitelist[oldImplementations[i]][newImplementations[i]] = statuses[i];
    }

    /**
     * @dev Whitelisted CErc20Delegate implementation contract addresses and `allowResign` values for each existing implementation.
     */
    mapping(address => mapping(address => mapping(bool => bool))) public cErc20DelegateWhitelist;

    /**
     * @dev Adds/removes CErc20Delegate implementations to the whitelist.
     * @param oldImplementations The old `CErc20Delegate` implementation addresses to upgrade from for each `newImplementations` to upgrade to.
     * @param newImplementations Array of `CErc20Delegate` implementations to be whitelisted/unwhitelisted.
     * @param allowResign Array of `allowResign` values corresponding to `newImplementations` to be whitelisted/unwhitelisted.
     * @param statuses Array of whitelist statuses corresponding to `newImplementations`.
     */
    function _editCErc20DelegateWhitelist(address[] calldata oldImplementations, address[] calldata newImplementations, bool[] calldata allowResign, bool[] calldata statuses) external onlyOwner {
        require(newImplementations.length > 0 && newImplementations.length == oldImplementations.length && newImplementations.length == allowResign.length && newImplementations.length == statuses.length, "No CErc20Delegate implementations supplied or array lengths not equal.");
        for (uint256 i = 0; i < newImplementations.length; i++) cErc20DelegateWhitelist[oldImplementations[i]][newImplementations[i]][allowResign[i]] = statuses[i];
    }

    /**
     * @dev Whitelisted CEtherDelegate implementation contract addresses and `allowResign` values for each existing implementation.
     */
    mapping(address => mapping(address => mapping(bool => bool))) public cEtherDelegateWhitelist;

    /**
     * @dev Adds/removes CEtherDelegate implementations to the whitelist.
     * @param oldImplementations The old `CEtherDelegate` implementation addresses to upgrade from for each `newImplementations` to upgrade to.
     * @param newImplementations Array of `CEtherDelegate` implementations to be whitelisted/unwhitelisted.
     * @param allowResign Array of `allowResign` values corresponding to `newImplementations` to be whitelisted/unwhitelisted.
     * @param statuses Array of whitelist statuses corresponding to `newImplementations`.
     */
    function _editCEtherDelegateWhitelist(address[] calldata oldImplementations, address[] calldata newImplementations, bool[] calldata allowResign, bool[] calldata statuses) external onlyOwner {
        require(newImplementations.length > 0 && newImplementations.length == oldImplementations.length && newImplementations.length == allowResign.length && newImplementations.length == statuses.length, "No CEtherDelegate implementations supplied or array lengths not equal.");
        for (uint256 i = 0; i < newImplementations.length; i++) cEtherDelegateWhitelist[oldImplementations[i]][newImplementations[i]][allowResign[i]] = statuses[i];
    }

    /**
     * @dev Latest Comptroller implementation for each existing implementation.
     */
    mapping(address => address) internal _latestComptrollerImplementation;

    /**
     * @dev Latest Comptroller implementation for each existing implementation.
     */
    function latestComptrollerImplementation(address oldImplementation) external view returns (address) {
        return _latestComptrollerImplementation[oldImplementation] != address(0) ? _latestComptrollerImplementation[oldImplementation] : oldImplementation;
    }

    /**
     * @dev Sets the latest `Comptroller` upgrade implementation address.
     * @param oldImplementation The old `Comptroller` implementation address to upgrade from.
     * @param newImplementation Latest `Comptroller` implementation address.
     */
    function _setLatestComptrollerImplementation(address oldImplementation, address newImplementation) external onlyOwner {
        _latestComptrollerImplementation[oldImplementation] = newImplementation;
    }

    struct CDelegateUpgradeData {
        address implementation;
        bool allowResign;
        bytes becomeImplementationData;
    }

    /**
     * @dev Latest CErc20Delegate implementation for each existing implementation.
     */
    mapping(address => CDelegateUpgradeData) public _latestCErc20Delegate;

    /**
     * @dev Latest CEtherDelegate implementation for each existing implementation.
     */
    mapping(address => CDelegateUpgradeData) public _latestCEtherDelegate;

    /**
     * @dev Latest CErc20Delegate implementation for each existing implementation.
     */
    function latestCErc20Delegate(address oldImplementation) external view returns (address, bool, bytes memory) {
        CDelegateUpgradeData memory data = _latestCErc20Delegate[oldImplementation];
        bytes memory emptyBytes;
        return data.implementation != address(0) ? (data.implementation, data.allowResign, data.becomeImplementationData) : (oldImplementation, false, emptyBytes);
    }

    /**
     * @dev Latest CEtherDelegate implementation for each existing implementation.
     */
    function latestCEtherDelegate(address oldImplementation) external view returns (address, bool, bytes memory) {
        CDelegateUpgradeData memory data = _latestCEtherDelegate[oldImplementation];
        bytes memory emptyBytes;
        return data.implementation != address(0) ? (data.implementation, data.allowResign, data.becomeImplementationData) : (oldImplementation, false, emptyBytes);
    }

    /**
     * @dev Sets the latest `CEtherDelegate` upgrade implementation address and data.
     * @param oldImplementation The old `CEtherDelegate` implementation address to upgrade from.
     * @param newImplementation Latest `CEtherDelegate` implementation address.
     * @param allowResign Whether or not `resignImplementation` should be called on the old implementation before upgrade.
     * @param becomeImplementationData Data passed to the new implementation via `becomeImplementation` after upgrade.
     */
    function _setLatestCEtherDelegate(address oldImplementation, address newImplementation, bool allowResign, bytes calldata becomeImplementationData) external onlyOwner {
        _latestCEtherDelegate[oldImplementation] = CDelegateUpgradeData(newImplementation, allowResign, becomeImplementationData);
    }

    /**
     * @dev Sets the latest `CErc20Delegate` upgrade implementation address and data.
     * @param oldImplementation The old `CErc20Delegate` implementation address to upgrade from.
     * @param newImplementation Latest `CErc20Delegate` implementation address.
     * @param allowResign Whether or not `resignImplementation` should be called on the old implementation before upgrade.
     * @param becomeImplementationData Data passed to the new implementation via `becomeImplementation` after upgrade.
     */
    function _setLatestCErc20Delegate(address oldImplementation, address newImplementation, bool allowResign, bytes calldata becomeImplementationData) external onlyOwner {
        _latestCErc20Delegate[oldImplementation] = CDelegateUpgradeData(newImplementation, allowResign, becomeImplementationData);
    }
}
